<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Chat en Vivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="chat-container">
    <header id="chat-header">
      <div class="title">ðŸ’¬ Chat</div>
      <div class="status" id="user-status">Desconectado</div>
    </header>

    <div id="user-setup">
      <input id="username" type="text" placeholder="Tu nombre..." />
      <button id="join-btn">Entrar</button>
    </div>

    <div id="messages"></div>

    <div id="input-area" style="display:none;">
      <input id="message-input" type="text" placeholder="Escribe un mensaje..." />
      <button id="send-btn" title="Enviar">âž¤</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let username = null;

    const userStatus = document.getElementById("user-status");
    const userSetup = document.getElementById("user-setup");
    const usernameInput = document.getElementById("username");
    const joinBtn = document.getElementById("join-btn");

    const messages = document.getElementById("messages");
    const inputArea = document.getElementById("input-area");
    const input = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");

    joinBtn.addEventListener("click", () => {
      const name = usernameInput.value.trim();
      if (!name) return;
      username = name;
      socket.emit("join", username);
      userSetup.style.display = "none";
      inputArea.style.display = "flex";
      userStatus.textContent = `${username} â€” en lÃ­nea`;
      input.focus();
    });

    function send() {
      const text = input.value.trim();
      if (!text || !username) return;
      socket.emit("chat message", { text });
      input.value = "";
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });

    socket.on("chat history", (history) => {
      messages.innerHTML = "";
      history.forEach((m) => addMessage(m, m.user === username));
      messages.scrollTop = messages.scrollHeight;
    });

    socket.on("chat message", (m) => {
      addMessage(m, m.user === username);
      messages.scrollTop = messages.scrollHeight;
    });

    socket.on("system", (text) => {
      const div = document.createElement("div");
      div.className = "system";
      div.textContent = text;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    });

    function addMessage(msg, isYou) {
      const wrapper = document.createElement("div");
      wrapper.className = "message " + (isYou ? "you" : "other");

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = msg.user;

      const body = document.createElement("div");
      body.className = "text";
      body.textContent = msg.text;

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = new Date(msg.time).toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit",
      });

      wrapper.appendChild(name);
      wrapper.appendChild(body);
      wrapper.appendChild(time);
      messages.appendChild(wrapper);
    }
  </script>
</body>
</html>
