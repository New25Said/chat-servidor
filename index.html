<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chat en Vivo</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="chat-container">
    <header>ðŸ’¬ Chat WhatsApp Style</header>

    <!-- setup de usuario -->
    <div id="user-setup">
      <input id="username" type="text" placeholder="Tu nombre...">
      <button id="join-btn">Entrar</button>
    </div>

    <!-- chat -->
    <div id="messages"></div>

    <div id="input-area" style="display:none;">
      <input id="message-input" type="text" placeholder="Escribe un mensaje...">
      <button id="send-btn">âž¤</button>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let username = null;

    const joinBtn = document.getElementById("join-btn");
    const usernameInput = document.getElementById("username");
    const userSetup = document.getElementById("user-setup");

    const messages = document.getElementById("messages");
    const inputArea = document.getElementById("input-area");
    const input = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");

    joinBtn.addEventListener("click", () => {
      if (usernameInput.value.trim()) {
        username = usernameInput.value.trim();
        socket.emit("join", username);
        userSetup.style.display = "none";
        inputArea.style.display = "flex";
      }
    });

    sendBtn.addEventListener("click", () => {
      if (input.value.trim()) {
        socket.emit("chat message", { user: username, text: input.value });
        input.value = "";
      }
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    // historial
    socket.on("chat history", (history) => {
      history.forEach(msg => addMessage(msg, msg.user === username));
    });

    // nuevos mensajes
    socket.on("chat message", (msg) => {
      addMessage(msg, msg.user === username);
    });

    // sistema
    socket.on("system", (msg) => {
      const div = document.createElement("div");
      div.className = "system";
      div.textContent = msg;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    });

    function addMessage(msg, isYou) {
      const div = document.createElement("div");
      div.className = "message " + (isYou ? "you" : "other");

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = msg.user;

      const text = document.createElement("div");
      text.className = "text";
      text.textContent = msg.text;

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = new Date(msg.time).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});

      div.appendChild(name);
      div.appendChild(text);
      div.appendChild(time);

      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }
  </script>
</body>
</html>
